<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AJAX запросы к REST</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="row">
      <h1 class="display-4">Лабораторная №4</h1> 
      <p class="lead">Напишите запросы к REST-сервису</p>
    </div>
    <div class="row">
      <div class="form-group col-md-12">
        <input 
          type="text" 
          class="form-control" 
          autocomplete="off"
	  placeholder="Название курса"
        />
      </div>	
      <div class="form-group col-md-12">
        <input 
          type="text" 
          class="form-control" 
          autocomplete="off"
	  placeholder="url"
        />
      </div>	
      <div class="form-group col-md-12">
        <input 
          type="text" 
          class="form-control" 
          autocomplete="off"
	  placeholder="Продолжительность"
        />
      </div>	
      <div class="form-group col-md-12">
        <input 
          type="button" 
          class="btn btn-primary"
          onclick='handleClick()'
          value="Добавить"
        />
      </div>	
    </div>
    <div class="row">
      <div class="form-group col-md-12" id="result">
      </div>	
    </div> 	
  </div>
  <script>

   function handleClick(){
     /*по нажатию должен подготовливаться и отправляться POST-запрос с данными курса title, url, duration */
     let [title,url,duration] = document.querySelectorAll('input')
     let xhr = new XMLHttpRequest();
     xhr.open('POST','/course', true);
     xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
     if(
         title.value.trim() &&
         url.value.trim() &&
         duration.value.trim() ){
       xhr.send(`title=${title.value}&url=${url.value}&duration=${duration.value}`)
     }

     /*При статусе ответа 200 нужно получить и выполнить JSON.parse() над responseText*/
     xhr.onreadystatechange = function(){
        if(xhr.readyState == 4 && xhr.status == 200){
          let res = JSON.parse(xhr.responseText);
          if( 'error' in res ){
            console.log(res);
/*при наличии 'error' in res вывести эту ошибку, иначе добавить к элементу с идентификатором result новый курс  */
            alert( res['error'] );
          } else {
            alert( res['message'] )
 /* на кнопку "Удалить" рядом с каждым курсом  навесить обработчик deleteCourse() - он будет по номеру курса удалять курс */    
            document.querySelector('#result').innerHTML += `
<div class="row" id="b${res.id}">
<div class="col-md-10">
<h4>Название: ${title.value}</h4>
<p>url: ${url.value}, продолжительность ${duration.value}
</div>
<div class="col-md-2">
  <button class='btn btn-success' onclick='deleteCourse(${res.id})'>Удалить</button>
</div>
</div>                        
`
          }
        } 
      }
     
     
 }
 
 function deleteCourse(id){
     /*по номеру курса подготовить POST запрос с параметрами _method=delete и id самого курса и выполнить его на адрес /course */
     let xhr = new XMLHttpRequest();
     xhr.open('POST','/course', true);
     xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
     xhr.send(`_method=delete&id=${id}`)

     xhr.onreadystatechange = function(){
        if(xhr.readyState == 4 && xhr.status == 200){
          let res = JSON.parse(xhr.responseText);
          alert( res['message'] )
          document.querySelector('#b'+id).remove();
        }
     }
     /*удалить сам курс из DOM*/
    
     
 }
  const init = () => {
    /*выполнить GET запрос к  /course, получить и вывести список всех курсов */
     let xhr = new XMLHttpRequest();
     xhr.open('GET','/course', true);
     xhr.send('');


    /*на каждый курс навесить обработчик с возможностью удаления по кнопке*/
    xhr.onreadystatechange = function(){
        if(xhr.readyState == 4 && xhr.status == 200){
          let courses = JSON.parse(xhr.responseText);
          courses.forEach(  course => {
            document.querySelector('#result').innerHTML += `
            <div class="row" id="b${course.id}">
            <div class="col-md-10">
            <h4>Название: ${course.title}</h4>
            <p>url: ${course.url}, продолжительность ${course.duration}
            </div>
            <div class="col-md-2">
              <button class='btn btn-success' onclick='deleteCourse(${course.id})'>Удалить</button>
            </div>
            </div>                        
            `

          })
        }
    }
  }
  init();
  </script>
  
</body>
</html>